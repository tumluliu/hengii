#include <mysql/mysql.h>
#include <sys/param.h>
#include <sys/stat.h>

#define MAX_PBS_ID_LENGTH 255
#define PARAM_SIZE      1024
#define HOST_DOMAIN  ".localhost.localdomain"
#define DB_SERVER    "gdos-yanan"
#define DB_USER      "myuser"
#define DB_PASSWORD  "mypassword"
#define DB_NAME      "higis"
#define PORT            3306


MYSQL_RES *query( char *que ) {
	int  t;
	unsigned int r;
	string query;
	string result ;
	MYSQL *conn_ptr;
	MYSQL_RES *res;
	MYSQL_ROW row;

	conn_ptr = mysql_init( NULL );

	if ( !conn_ptr ) {
		fprintf( stderr, "mysql_init failed\n" );
	}

	conn_ptr = mysql_real_connect( conn_ptr, DB_SERVER.c_str(), DB_USER.c_str(), DB_PASSWORD.c_str(), DB_NAME.c_str(), PORT, NULL, 0 );

	if ( conn_ptr ) {
		cout << "Connection success" << endl;
	}
	else {
		cout << "Connection failed" << endl;
	}

	query = que;
	t = mysql_query( conn_ptr, query.c_str() );

	if ( t ) {
		cout << "Error making query: " << mysql_error( conn_ptr ) << endl;
	}
	else {
		cout << "Query made..." << endl;
	}

	mysql_close( conn_ptr );

	return mysql_store_result( conn_ptr );

}

void getValue( MYSQL_RES *res, int row_id, int col_id, char *result ) {
	MYSQL_ROW row; 

	row = mysql_data_seek( res, row_id );
	strcpy( result, row[col_id] );
}

void freeRes( MYSQL_RES *res ) {
	mysql_free_result( res );
}

void getPbsJobIds( char **ids ) {
	const char *sql = "select pbs_job_id from gdos_sys_job;";
	MYSQL_RES *res;
	char record[MAX_PBS_ID_LENGTH];
	unsigned int i;

	res = query( sql );
	for ( i = 0; i < mysql_num_fields( res ); i++ ) {
		getValue(res, i, 0, record);
		strcpy( ids[i], record );
	}
}

int countJobs() {
	return 0;
}

void test() {
	char **ids;
	idCount = 7;

	ids = ( char ** )calloc( sizeof( char ) * MAX_PBS_ID_LENGTH, idCount );
	getPbsJobIds( ids );
	for ( i = 0; i < idCount; i++ ) {
		printf("%s\n", ids[i]);
	}
}

int main( int argc, char **argv ) {
	test();
	/*char **ids;*/
	/*int jobCount;*/

	/*do {*/
		/*idCount = countJobs();*/
		/*ids = ( char ** )calloc( sizeof( char ) * MAX_PBS_ID_LENGTH, idCount );*/
		/*getPbsJobIds( ids );*/
		/*for ( i = 0; i < idCount; i++ ) {*/
			/*update_status( ids[i] );*/
		/*}*/
	/*} while ( true );*/

	/*return 1;*/
}

/*void init_daemon(void) {*/
/*int pid;*/
/*int i;*/

/*if ((pid = fork()) == 0) {*/
/*exit(0);*/
/*} else if(pid < 0) {*/
/*exit(1);*/
/*}*/

/*setsid();*/

/*if ((pid = fork()) == 0) {*/
/*exit(0);*/
/*} else if(pid < 0) {*/
/*exit(1);*/
/*}*/

/*for(i = 0; i < NOFILE; ++i) {*/
/*close(i);*/
/*}*/

/*umask(0);*/
/*return;*/
/*}*/
